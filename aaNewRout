from flask import Blueprint, render_template, request
from app import app, celery
from models import KPIs, DataCache, RedisCache, FileCache
import config

main_bp = Blueprint('main', __name__)

# Register Blueprint routes
app.register_blueprint(main_bp)

@main_bp.route('/', methods=['GET', 'POST'])
def index():
    cache = RedisCache() if config.PREFER_REDIS else FileCache()
    data_cache = DataCache(cache)
    view_ids = ["view1", "view2", "view3"]
    df_dict = data_cache.get_data_dict("tableau_data", view_ids)

    filters = request.form.getlist('filters') if request.method == 'POST' else []
    kpi_instance = KPIs()

    metrics = {}
    for view_id, df in df_dict.items():
        if df is not None:
            if filters:
                df = df[df['category'].isin(filters)]
            metrics[view_id] = {
                'value_counts': kpi_instance.get_value_counts(df, 'category'),
                'pivot_table': kpi_instance.create_pivot(df, 'date', 'category', 'value')
            }

    return render_template('index.html', metrics=metrics, filters=filters)
